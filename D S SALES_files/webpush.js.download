var pushSubscription=document.getElementById('pushSubscription');var pushPWA=document.getElementById('push-pwa');if(navigator.serviceWorker&&window.Notification&&pushSubscription){navigator.serviceWorker.ready.then(function(registration){return registration.pushManager.getSubscription();}).then(function(subscription){pushSubscription.classList.remove('d-none');if(subscription){setUnsubscribeButton();}else{pushSubscription.innerHTML=pushSubscription.getAttribute('data-follow')||'Follow';pushSubscription.onclick=subscribe;}});}
function subscribe(){pushSubscription.setAttribute("disabled",true);navigator.serviceWorker.ready.then(async function(registration){const response=await fetch('/push/',{method:'get'});const vapidPublicKey=await response.text();const convertedVapidKey=urlBase64ToUint8Array(vapidPublicKey);return registration.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:convertedVapidKey});}).then(function(subscription){return fetch('/push/',{method:'post',headers:{'Content-type':'application/json','Accept':'application/json'},body:JSON.stringify({subscription:subscription}),credentials:'same-origin'}).then(function(response){return response.json();}).then(function(data){navigator.serviceWorker.controller.postMessage(data);}).catch(function(err){console.log(err);});}).then(setUnsubscribeButton).catch(pushSubscriptionRemove);}
function unsubscribe(){pushSubscription.setAttribute("disabled",true);navigator.serviceWorker.ready.then(function(registration){return registration.pushManager.getSubscription();}).then(function(subscription){return subscription.unsubscribe().then(function(){return fetch('/push/',{method:'delete',headers:{'Content-type':'application/json'},body:JSON.stringify({subscription:subscription}),credentials:'same-origin'});});}).then(setSubscribeButton).catch(pushSubscriptionRemove);}
function pushSubscriptionRemove(){if(pushSubscription)pushSubscription.remove();if(pushPWA)pushPWA.remove();}
function setSubscribeButton(){pushSubscription.removeAttribute("disabled");pushSubscription.onclick=subscribe;if(Notification.permission==="denied"){pushSubscriptionRemove();}
else if(Notification.permission==="granted"){pushSubscription.innerHTML=pushSubscription.getAttribute('data-follow')||'Follow';}
else if(Notification.permission!=="denied"){Notification.requestPermission().then(function(permission){if(permission==="granted"){pushSubscription.innerHTML=pushSubscription.getAttribute('data-follow')||'Follow';}});}
else{pushSubscriptionRemove();}}
function setUnsubscribeButton(){if(pushSubscription){pushSubscription.onclick=unsubscribe;pushSubscription.innerHTML=pushSubscription.getAttribute('data-unfollow')||'Unfollow';pushSubscription.removeAttribute("disabled");}}